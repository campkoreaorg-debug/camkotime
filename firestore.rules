
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSessionOwner(sessionId) {
      return request.auth != null && get(/databases/$(database)/documents/sessions/$(sessionId)).data.ownerId == request.auth.uid;
    }
    
    function isPublic(sessionId) {
      // isPublic is a boolean on the venue document.
      // The venue document ID is 'main-venue'.
      return get(/databases/$(database)/documents/sessions/$(sessionId)/venue/main-venue).data.isPublic == true;
    }

    // Sessions collection
    match /sessions/{sessionId} {
       allow get: if isSessionOwner(sessionId) || isPublic(sessionId);
       allow create: if request.auth != null && request.resource.data.ownerId == request.auth.uid;
       allow update, delete: if isSessionOwner(sessionId);
       allow list: if request.auth != null; // For admin to list their own sessions
    }

    // Venue subcollection
    match /sessions/{sessionId}/venue/{venueId} {
      allow get, list: if isSessionOwner(sessionId) || isPublic(sessionId);
      allow write: if isSessionOwner(sessionId);
    }
    
    // Staff subcollection
    match /sessions/{sessionId}/staff/{staffId} {
      allow get, list: if isSessionOwner(sessionId) || isPublic(sessionId);
      allow write: if isSessionOwner(sessionId);
    }
    
    // Schedules subcollection
    match /sessions/{sessionId}/schedules/{scheduleId} {
      allow get, list: if isSessionOwner(sessionId) || isPublic(sessionId);
      allow write: if isSessionOwner(sessionId);
    }
    
    // Markers subcollection
    match /sessions/{sessionId}/markers/{markerId} {
      allow get, list: if isSessionOwner(sessionId) || isPublic(sessionId);
      allow write: if isSessionOwner(sessionId);
    }
    
    // Maps subcollection
    match /sessions/{sessionId}/maps/{mapId} {
      allow get, list: if isSessionOwner(sessionId) || isPublic(sessionId);
      allow write: if isSessionOwner(sessionId);
    }
    
    // Roles subcollection (document access)
    match /sessions/{sessionId}/roles/{roleId} {
      allow get, list: if isSessionOwner(sessionId) || isPublic(sessionId);
      allow write: if isSessionOwner(sessionId);
    }
    
    // TimeSlotInfo subcollection
    match /sessions/{sessionId}/timeSlotInfo/{timeSlotInfoId} {
      allow get, list: if isSessionOwner(sessionId) || isPublic(sessionId);
      allow write: if isSessionOwner(sessionId);
    }

    // Roles collection group query access
    match /roles/{roleId} {
        // Read access is allowed if the user is the owner of the parent session document.
        allow read: if request.auth != null && get(resource.__name__[0]).data.ownerId == request.auth.uid;
    }
    
    // ScheduleTemplates subcollection
    match /sessions/{sessionId}/scheduleTemplates/{templateId} {
      allow read, write: if isSessionOwner(sessionId);
    }
  }
}
